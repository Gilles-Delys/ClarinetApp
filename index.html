<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clarinet Pro Trainer</title>
    <style>
        :root {
            /* Palette Awesome Blue */
            --bg-gradient: linear-gradient(135deg, #245268 0%, #388aa5 50%, #3daad8 100%);
            --panel-bg: rgba(255, 255, 255, 0.1);
            --panel-border: rgba(255, 255, 255, 0.2);
            --text-color: #ffffff;
            --primary-accent: #00d2ff; /* Bleu cyan vibrant */
            --success-color: #2ecc71;  /* Vert √©meraude */
            --current-note-color: #e74c3c; /* Rouge vif pour la note active */
            --pending-note-color: #000000; /* Noir pour les notes √† venir */
            --error-color: #ff6b6b;
            --font-main: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Effet de verre (Glassmorphism) */
        .glass-panel {
            background: var(--panel-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--panel-border);
            border-radius: 15px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        header {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.5rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary-accent);
            text-shadow: 0 0 10px rgba(0, 210, 255, 0.5);
            letter-spacing: 1px;
        }

        #controls {
            margin: 10px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            padding: 0 12px;
        }

        button, select {
            padding: 5px 10px;
            border-radius: 5px; /* Boutons arrondis */
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            font-family: var(--font-main);
        }

        button:hover, select:hover { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        
        button#start-btn { 
            background: linear-gradient(45deg, #11998e, #38ef7d); 
            color: #fff; 
        }
        
        button#next-btn { 
            background: var(--primary-accent); 
            color: #003; 
            display: none; 
        }

        select {
            background: rgba(255,255,255,0.9);
            color: #333;
        }

        #main-display {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 40px;
            width: 95%;
            max-width: 1200px;
            margin-bottom: 20px;
        }

        .panel {
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 300px;
        }
        
        h3 { margin-top: 0; color: #ddd; font-weight: 400; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 2px; width: 100%; text-align: center; }

        /* Canvas Port√©e */
        #staff-container { width: 100%; max-width: 400px; height: 250px; position: relative; display: flex; justify-content: center; }
        canvas#staff-canvas { background-color: rgba(255,255,255,0.95); border-radius: 8px; box-shadow: inset 0 0 20px rgba(0,0,0,0.1); }

        /* Clarinette Visuelle */
        #fingering-container { width: 300px; height: 500px; position: relative; }
        .clarinet-svg { height: 100%; width: auto; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        
        /* SVG Classes */
        .key { fill: #bbb; stroke: #555; stroke-width: 1; transition: fill 0.2s; }
        .key.active { fill: var(--primary-accent); stroke: #fff; filter: drop-shadow(0 0 5px var(--primary-accent)); }
        .hole { fill: #222; stroke: #888; stroke-width: 2; }
        .hole.closed { fill: var(--primary-accent); stroke: #fff; }

        #feedback-area {
            margin-top: 1px;
            text-align: center;
            min-height: 80px;
            width: 100%;
            max-width: 600px;
        }

        .status-detected { color: #fff; font-size: 1rem; margin-bottom: 1px; }
        .status-match { 
            color: var(--success-color); 
            font-weight: bold; 
            font-size: 1.8rem; 
            text-shadow: 0 0 10px rgba(46, 204, 113, 0.4);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        #tuner-bar {
            width: 100%;
            height: 18px;
            background: rgba(0,0,0,0.5);
            margin-top: 1px;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #tuner-indicator {
            width: 10px;
            height: 100%;
            background: #fff;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.1s linear, background-color 0.2s;
            border-radius: 3px;
            box-shadow: 0 0 5px #fff;
        }
        #center-marker {
            width: 2px;
            height: 100%;
            background: var(--success-color);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            opacity: 0.7;
        }

    </style>
</head>
<body>

<header>
    <h1>Clarinet Trainer üéµ</h1>
    <div style="font-size: 0.9rem; opacity: 0.8; margin-top: 1px;">Microphone requis ‚Ä¢ Jouez la note <b>Rouge</b></div>
</header>

<div id="controls">
    <select id="mode-select">
        <option value="single">Mode: 1 Note (Classique)</option>
        <option value="series">Mode: S√©rie (5 Notes)</option>
    </select>
    <select id="level-select">
        <option value="1">Niveau 1: Chalumeau (Mi3 - La4)</option>
        <option value="2">Niveau 2: Passage (La3 - Do5)</option>
        <option value="3">Niveau 3: Clairon (Si4 - Do6)</option>
        <option value="4">Niveau 4: Chromatique Complet</option>
        <option value="5">Niveau 5: Altissimo & Sauts</option>
    </select>
    <button id="start-btn">Commencer</button>
    <button id="next-btn">Note Suivante</button>
</div>

<div id="feedback-area">
    <div id="instruction" style="font-size: 1.2rem; color: #fff;">Appuyez sur "Activer Micro" pour commencer.</div>
    <div id="detected-note" class="status-detected">--</div>
    <div id="tuner-bar"><div id="center-marker"></div><div id="tuner-indicator"></div></div>
</div>

<div id="main-display">
    <div class="panel glass-panel">
        <h3>Partition</h3>
        <div id="staff-container">
            <canvas id="staff-canvas" width="380" height="250"></canvas>
            <!-- Script directement dans la page -->
            <script>
            // Code JavaScript
            //alert("Bienvenue sur ma page !");
            displayElement.innerHTML = `<span class="status-match">BRAVO !</span>`;
            //console.log("Script ex√©cut√© !");
            </script>
        </div>
        <div id="note-name-display" style="margin-top:5px; font-size:1.5rem; font-weight:bold; color:var(--primary-accent);"></div>
    </div>

    <div class="panel glass-panel">
        <h3>Doigt√© (Syst√®me Boehm)</h3>
        <div id="fingering-container">
            <svg class="clarinet-svg" viewBox="0 0 100 400" xmlns="http://www.w3.org/2000/svg">
                <rect x="40" y="10" width="20" height="380" rx="10" fill="#111" stroke="#333"/>
                
                <circle id="key-R" class="key" cx="25" cy="40" r="6" />
                <text x="5" y="45" fill="#888" font-size="8">12(R)</text>

                <circle id="key-T" class="hole" cx="50" cy="55" r="5" />
                <text x="75" y="60" fill="#888" font-size="8">T</text>

                <rect id="key-A" class="key" x="35" y="20" width="10" height="5" /> 
                <rect id="key-Ab" class="key" x="35" y="28" width="10" height="5" /> 
                
                <circle id="key-L1" class="hole" cx="50" cy="80" r="5" />
                <circle id="key-L2" class="hole" cx="50" cy="100" r="5" />
                <circle id="key-L3" class="hole" cx="50" cy="120" r="5" />
                
                <rect id="key-L4-E" class="key" x="65" y="130" width="15" height="8" rx="2"/> 
                <rect id="key-L4-F" class="key" x="65" y="140" width="15" height="8" rx="2"/> 
                <rect id="key-L4-Fsharp" class="key" x="20" y="135" width="15" height="8" rx="2"/> 
                
                <circle id="key-R1" class="hole" cx="50" cy="180" r="5" />
                <circle id="key-R2" class="hole" cx="50" cy="200" r="5" />
                <circle id="key-R3" class="hole" cx="50" cy="220" r="5" />

                <rect id="key-Side1" class="key" x="65" y="90" width="8" height="20" rx="2"/> 

                <rect id="key-R4-E" class="key" x="20" y="230" width="15" height="8" rx="2"/>
                <rect id="key-R4-F" class="key" x="20" y="240" width="15" height="8" rx="2"/>
                <rect id="key-R4-Fsharp" class="key" x="65" y="235" width="15" height="8" rx="2"/>
                <rect id="key-R4-Gsharp" class="key" x="65" y="215" width="15" height="8" rx="2"/> 
            </svg>
        </div>
    </div>
</div>

<script>
/**
 * --- TRADUCTION ET DONN√âES ---
 */
const FR_NOTES = {
    "C": "Do", "C#": "Do#", "D": "R√©", "D#": "R√©#", "E": "Mi", "F": "Fa", 
    "F#": "Fa#", "G": "Sol", "G#": "Sol#", "A": "La", "A#": "La#", "B": "Si"
};

function getFrenchNoteName(noteKey) {
    // Ex: "F#4" -> notePart="F#", octavePart="4"
    const match = noteKey.match(/^([A-G]#?)(\d)$/);
    if (match) {
        const name = FR_NOTES[match[1]] || match[1];
        return `${name} ${match[2]}`;
    }
    return noteKey;
}

const NOTES_DATA = {
    "E3": { freq: 146.83, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-E"] },
    "F3": { freq: 155.56, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-F"] },
    "F#3": { freq: 164.81, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Fsharp"] },
    "G3": { freq: 174.61, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3"] },
    "G#3": { freq: 185.00, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Gsharp"] },
    "A3": { freq: 196.00, keys: ["T", "L1", "L2", "L3", "R1", "R2"] },
    "A#3": { freq: 207.65, keys: ["T", "L1", "L2", "L3", "R1"] }, 
    "B3": { freq: 220.00, keys: ["T", "L1", "L2", "L3", "R2"] }, 
    "C4": { freq: 233.08, keys: ["T", "L1", "L2", "L3"] },
    "C#4": { freq: 246.94, keys: ["T", "L1", "L2", "L3", "L4-Fsharp"] },
    "D4": { freq: 261.63, keys: ["T", "L1", "L2"] },
    "D#4": { freq: 277.18, keys: ["T", "L1", "L2", "Side1"] },
    "E4": { freq: 293.66, keys: ["T", "L1"] },
    "F4": { freq: 311.13, keys: ["T"] },
    "F#4": { freq: 329.63, keys: ["L1"] },
    "G4": { freq: 349.23, keys: [] }, 
    "G#4": { freq: 369.99, keys: ["Ab"] },
    "A4": { freq: 392.00, keys: ["A"] },
    "A#4": { freq: 415.30, keys: ["A", "R"] }, 
    "B4": { freq: 440.00, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-E"] },
    "C5": { freq: 466.16, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-F"] },
    "C#5": { freq: 493.88, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Fsharp"] },
    "D5": { freq: 523.25, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3"] },
    "D#5": { freq: 554.37, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Gsharp"] },
    "E5": { freq: 587.33, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2"] },
    "F5": { freq: 622.25, keys: ["R", "T", "L1", "L2", "L3", "R1"] },
    "F#5": { freq: 659.25, keys: ["R", "T", "L1", "L2", "L3", "R2"] },
    "G5": { freq: 698.46, keys: ["R", "T", "L1", "L2", "L3"] },
    "G#5": { freq: 739.99, keys: ["R", "T", "L1", "L2", "L3", "R4-Gsharp"] },
    "A5": { freq: 783.99, keys: ["R", "T", "L1", "L2"] },
    "A#5": { freq: 830.61, keys: ["R", "T", "L1", "L2", "Side1"] },
    "B5": { freq: 880.00, keys: ["R", "T", "L1"] },
    "C6": { freq: 932.33, keys: ["R", "T"] }
};

const LEVELS = {
    1: ["E3", "F3", "G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4"], 
    2: ["G3", "A3", "B3", "C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5"], 
    3: ["C4", "D4", "E4", "F4", "G4", "A4", "B4", "C5", "D5", "E5", "F5", "G5"], 
    4: ["C#4", "D#4", "F#4", "G#4", "A#4", "C#5", "D#5", "F#5", "G#5"], 
    5: Object.keys(NOTES_DATA) 
};

/**
 * --- ETAT DU JEU ---
 */
let noteQueue = []; // Liste des notes √† jouer (1 ou 5)
let queueIndex = 0; // Index actuel dans la file

/**
 * --- MOTEUR AUDIO (Inchang√© pour stabilit√©) ---
 */
let audioContext;
let analyser;
let microphone;
let isListening = false;

async function initAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        
        isListening = true;
        updatePitch();
        
        document.getElementById('start-btn').style.display = 'none';
        
        // Affichage du bouton "Suivant" seulement en mode 1 note
        updateControlsVisibility();
        
        document.getElementById('instruction').innerText = "C'est parti !";
        
        startNewSequence(); // Lance le jeu
    } catch (err) {
        alert("Erreur Micro: " + err);
    }
}

function updateControlsVisibility() {
    const mode = document.getElementById('mode-select').value;
    document.getElementById('next-btn').style.display = (mode === 'single' && isListening) ? 'inline-block' : 'none';
}

function autoCorrelate(buf, sampleRate) {
    let size = buf.length;
    let rms = 0;
    for (let i = 0; i < size; i++) { let val = buf[i]; rms += val * val; }
    rms = Math.sqrt(rms / size);
    if (rms < 0.01) return -1; 

    let r1 = 0, r2 = size - 1, thres = 0.2;
    for (let i = 0; i < size / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
    for (let i = 1; i < size / 2; i++) if (Math.abs(buf[size - i]) < thres) { r2 = size - i; break; }

    buf = buf.slice(r1, r2);
    size = buf.length;

    let c = new Array(size).fill(0);
    for (let i = 0; i < size; i++) for (let j = 0; j < size - i; j++) c[i] = c[i] + buf[j] * buf[j + i];

    let d = 0; while (c[d] > c[d + 1]) d++;
    let maxval = -1, maxpos = -1;
    for (let i = d; i < size; i++) { if (c[i] > maxval) { maxval = c[i]; maxpos = i; } }
    let T0 = maxpos;
    let x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
    let a = (x1 + x3 - 2 * x2) / 2;
    let b = (x3 - x1) / 2;
    if (a) T0 = T0 - b / (2 * a);

    return sampleRate / T0;
}

function updatePitch() {
    if (!isListening) return;
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    const freq = autoCorrelate(buf, audioContext.sampleRate);
    if (freq !== -1) checkNote(freq);
    requestAnimationFrame(updatePitch);
}

/**
 * --- LOGIQUE DE JEU (S√âRIE VS SINGLE) ---
 */

function getRandomNote(level) {
    const notesPool = LEVELS[level];
    return notesPool[Math.floor(Math.random() * notesPool.length)];
}

function startNewSequence() {
    const mode = document.getElementById('mode-select').value;
    const level = parseInt(document.getElementById('level-select').value);
    
    noteQueue = [];
    queueIndex = 0;
    
    const count = (mode === 'series') ? 5 : 1;
    
    for(let i=0; i<count; i++) {
        // Simple logique pour √©viter la m√™me note deux fois de suite dans la g√©n√©ration
        let newNote;
        do {
            newNote = getRandomNote(level);
        } while (noteQueue.length > 0 && newNote === noteQueue[noteQueue.length-1]);
        noteQueue.push(newNote);
    }
    
    updateUI();
}

function updateUI() {
    // Reset status
    document.getElementById('detected-note').innerText = "...";
    document.getElementById('tuner-indicator').style.left = "50%";
    document.getElementById('tuner-indicator').style.backgroundColor = "#fff";

    const currentNote = noteQueue[queueIndex];
    
    // Affichage Canvas
    drawStaff(noteQueue, queueIndex);
    
    // Affichage Doigt√© (seulement pour la note courante)
    if(currentNote) {
        showFingering(currentNote);
        document.getElementById('note-name-display').innerText = getFrenchNoteName(currentNote);
    } else {
        // Fin de s√©rie
        document.getElementById('note-name-display').innerText = "S√©rie termin√©e !";
    }
}

function checkNote(detectedFreq) {
    // Si s√©rie finie ou pas commenc√©e
    if (queueIndex >= noteQueue.length) return;

    const currentTarget = noteQueue[queueIndex];
    const targetData = NOTES_DATA[currentTarget];
    const targetFreq = targetData.freq;
    
    // const centsDiff = 1200 * Math.log2(detectedFreq / targetFreq); // Valeur d'Origine
    const centsDiff = 600 * Math.log2(detectedFreq / targetFreq); // Modif Gillou Pr√©cision plus tol√©rante

    // Tuner UI
    const tunerIndicator = document.getElementById('tuner-indicator');
    let displayCents = Math.max(-50, Math.min(50, centsDiff));
    tunerIndicator.style.left = `${50 + displayCents}%`;
    
    const displayElement = document.getElementById('detected-note');
    
    // D√©tection de succ√®s (+/- 15 cents) (augment√© √† +/- 20 Cents)
    if (Math.abs(centsDiff) < 20) {
        tunerIndicator.style.backgroundColor = "var(--success-color)";
        
        // Verrouillage temporaire pour √©viter les doubles d√©clenchements rapides
        if (!displayElement.dataset.successLocked) {
            displayElement.dataset.successLocked = "true";
            
            // Logique selon le mode
            const mode = document.getElementById('mode-select').value;
            
            if (mode === 'series') {
                // Mode S√©rie : On avance tout de suite
                displayElement.innerHTML = `<span class="status-match">${getFrenchNoteName(currentTarget)} OK!</span>`;
                queueIndex++;
                
                // Petit d√©lai visuel tr√®s court
                setTimeout(() => {
                    displayElement.dataset.successLocked = "";
                    if (queueIndex >= noteQueue.length) {
                          // Fin de s√©rie : d√©lai plus long avant nouvelle s√©rie
                          displayElement.innerHTML = `<span class="status-match" style="color:#fff">S√âRIE TERMIN√âE !</span>`;
                          drawStaff(noteQueue, queueIndex); // Redessine pour montrer tout vert
                          setTimeout(startNewSequence, 1500);
                    } else {
                        updateUI();
                    }
                }, 200); // R√©actif
                
            } else {
                // Mode Single : Pause gratifiante
                displayElement.innerHTML = `<span class="status-match">BRAVO !</span>`;
                setTimeout(() => {
                    displayElement.dataset.successLocked = "";
                    startNewSequence();
                }, 1500);
            }
        }
    } else {
        displayElement.innerText = `D√©tect√©: ${Math.round(detectedFreq)} Hz`;
        tunerIndicator.style.backgroundColor = Math.abs(centsDiff) > 50 ? "var(--error-color)" : "#fff";
    }
}

/**
 * --- DESSIN CANVAS (MULTIPLE NOTES) ---
 */
const canvas = document.getElementById('staff-canvas');
const ctx = canvas.getContext('2d');

function drawStaff(notes, activeIndex) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const startX = 40;
    const endX = canvas.width - 40;
    const staffY = 100; 
    const lineSpacing = 15;
    
    // Lignes de port√©e
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1;
    for (let i = 0; i < 5; i++) {
        let y = staffY + (i * lineSpacing);
        ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(endX, y); ctx.stroke();
    }
    
    // Cl√© de sol
    ctx.font = "60px serif";
    ctx.fillStyle = "#333";
    ctx.fillText("ùÑû", 10, staffY + 45);

    // Dessin des notes
    // Si 1 note : centr√©e. Si 5 notes : r√©parties.
    let xSpacing = (canvas.width - 100) / (notes.length > 1 ? notes.length : 1);
    let xOffset = (notes.length === 1) ? (canvas.width / 2) : 60;

    // Mapping positions verticales
    const noteStepsFromTop = {
        "C6": -2, "B5": -1.5, "A#5": -1, "A5": -1, "G#5": -0.5, "G5": -0.5,
        "F#5": 0, "F5": 0, "E5": 0.5, "D#5": 1, "D5": 1, "C#5": 1.5, "C5": 1.5,
        "B4": 2, "A#4": 2.5, "A4": 2.5, "G#4": 3, "G4": 3, "F#4": 3.5, "F4": 3.5,
        "E4": 4, "D#4": 4.5, "D4": 4.5, "C#4": 5, "C4": 5, "B3": 5.5,
        "A#3": 6, "A3": 6, "G#3": 6.5, "G3": 6.5, "F#3": 7, "F3": 7, "E3": 7.5
    };

    notes.forEach((noteName, idx) => {
        const steps = noteStepsFromTop[noteName];
        const noteY = staffY + (steps * lineSpacing);
        
        // Calcul position X
        let noteX = xOffset;
        if (notes.length > 1) {
            noteX = 80 + (idx * ((canvas.width - 120) / (notes.length - 1)));
        }

        // Lignes suppl√©mentaires
        ctx.strokeStyle = "#333"; // Lignes toujours noires
        if (steps >= 5) { 
            for (let s = 5; s <= steps; s++) {
                if (s % 1 === 0) {
                    let ly = staffY + (s * lineSpacing);
                    ctx.beginPath(); ctx.moveTo(noteX - 15, ly); ctx.lineTo(noteX + 15, ly); ctx.stroke();
                }
            }
        }
        if (steps <= -1) { 
            for (let s = -1; s >= steps; s--) {
                if (s % 1 === 0) {
                    let ly = staffY + (s * lineSpacing);
                    ctx.beginPath(); ctx.moveTo(noteX - 15, ly); ctx.lineTo(noteX + 15, ly); ctx.stroke();
                }
            }
        }

        // COULEUR DE LA NOTE
        // Pass√© (idx < activeIndex) = Vert
        // Actuel (idx == activeIndex) = Rouge
        // Futur (idx > activeIndex) = Noir
        let noteColor = "var(--pending-note-color)";
        if (idx < activeIndex) noteColor = "var(--success-color)";
        else if (idx === activeIndex) noteColor = "var(--current-note-color)";

        // Dessin T√™te
        ctx.beginPath();
        ctx.ellipse(noteX, noteY, 10, 8, 0, 0, 2 * Math.PI);
        
        // Hack pour utiliser les variables CSS dans le canvas
        if(noteColor.startsWith("var")) {
            if(noteColor.includes("success")) ctx.fillStyle = "#2ecc71";
            else if(noteColor.includes("current")) ctx.fillStyle = "#e74c3c";
            else ctx.fillStyle = "#000";
        } else {
            ctx.fillStyle = noteColor;
        }
        ctx.fill();

        // Di√®se (#)
        if (noteName.includes("#")) {
            ctx.font = "20px Arial";
            ctx.fillText("‚ôØ", noteX - 25, noteY + 5);
        }
    });
}

function showFingering(noteName) {
    // CORRECTION ICI : On vide le style inline pour laisser le CSS (classes .key .hole) g√©rer les couleurs
    document.querySelectorAll('.key, .hole').forEach(el => {
        el.style.fill = "";   // On enl√®ve le style forc√©
        el.style.stroke = ""; // On enl√®ve le style forc√©
        el.classList.remove('active', 'closed'); // On enl√®ve l'√©tat actif
    });

    const data = NOTES_DATA[noteName];
    if (!data) return;

    data.keys.forEach(keyId => {
        const el = document.getElementById(`key-${keyId}`);
        if (el) {
            if (el.classList.contains('hole')) {
                el.classList.add('closed'); // CSS g√®re la couleur via classe
            } else {
                el.classList.add('active'); // CSS g√®re la couleur via classe
            }
        }
    });
}

// Events
document.getElementById('start-btn').addEventListener('click', initAudio);
document.getElementById('next-btn').addEventListener('click', startNewSequence); // Bouton manuel
document.getElementById('level-select').addEventListener('change', () => { if(isListening) startNewSequence(); });
document.getElementById('mode-select').addEventListener('change', () => { 
    updateControlsVisibility();
    if(isListening) startNewSequence(); 
});

</script>
</body>
</html>