<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Clarinette</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Palette M√©diterran√©e Awesome */
            --bg-gradient: linear-gradient(135deg, #0b4aa7 0%, #0f4ba5 35%, #1c71bb 70%, #27a4ec 100%);
            --glass-bg: rgba(255, 255, 255, 0.15);
            --glass-border: rgba(255, 255, 255, 0.25);
            
            --text-main: #ffffff;
            /* Modif Gillou: couleur des Cl√©s √† boucher */
            --primary-btn: #e81616;
            /* --primary-btn: #00b4d8;  Valeur d'origine */
            --start-btn: #06d6a0;
            --danger-color: #ef476f;
            --accent-gold: #ffd166;
            /* Modif Gillou: Recherche de la couleur du nom de la note mais c'est pas √ßa ! */
            /* --note-current: #ef476f; */
            --note-current: #60ef47;
            --note-success: #06d6a0;
            --note-pending: #000000;
            
            --font-main: 'Poppins', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background: var(--bg-gradient);
            background-attachment: fixed;
            color: var(--text-main);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .app-container {
            width: 100%;
            max-width: 1200px;
            padding: 4px; /* Tr√®s r√©duit pour mobile */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 15px; /* Rayon r√©duit */
            box-shadow: 0 4px 16px 0 rgba(0, 0, 0, 0.3);
            margin: 4px;
            transition: transform 0.3s ease;
        }

        header {
            width: 100%;
            padding: 2px 0;
            text-align: center;
            margin-bottom: 4px;
        }

        h1 {
            margin: 0;
            font-size: 1.4rem; /* Plus petit */
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Controls Section - Optimis√© Compact */
        #controls {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            width: 100%;
            padding: 6px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            margin-bottom: 4px;
            box-sizing: border-box;
        }

        select {
            padding: 4px 8px;
            border-radius: 6px;
            border: none;
            background: #fff;
            color: #333;
            font-family: var(--font-main);
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23007CB2%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
            background-repeat: no-repeat;
            background-position: right .5em top 50%;
            background-size: .55em auto;
            padding-right: 1.5em;
            height: 32px; /* Force height compact */
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(255,255,255,0.1);
            padding: 2px 6px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.2);
            height: 40px;   /* D'origine: 32px */
            justify-content: center;
        }
        
        .slider-label {
            font-size: 0.6rem;
            margin-bottom: 0;
            color: #a8dadc;
            line-height: 1;
        }

        input[type=range] {
            -webkit-appearance: none;
            width: 80px; 
            background: transparent;
            margin: 2px 0;
            height: 10px;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: var(--accent-gold);
            cursor: pointer;
            margin-top: -4px;
        }
        
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.5);
            border-radius: 2px;
        }

        button {
            padding: 0 10px;
            height: 32px;
            border-radius: 6px;
            border: none;
            font-family: var(--font-main);
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            text-transform: uppercase;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        button:active { transform: scale(0.95); }
        button#start-btn { background: var(--start-btn); color: #1d3557; }
        button#next-btn { background: var(--accent-gold); color: #1d3557; display: none; }

        /* Layout Principal */
        #main-display {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
            justify-content: center;
            align-items: flex-start;
            gap: 6px;
            width: 100%;
        }

        .panel {
            padding: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1 1 300px;
            min-width: 0;
            width: 100%;
            max-width: 600px;
            box-sizing: border-box;
        }
        
        h3 { 
            margin: 2px 0 6px 0; 
            color: #a8dadc; 
            font-weight: 400; 
            border-bottom: 1px solid rgba(255,255,255,0.2); 
            padding-bottom: 2px; 
            width: 100%; 
            text-align: center; 
            font-size: 0.9rem;
        }

        /* Canvas Port√©e Container */
        #staff-container { 
            width: 100%; 
            height: auto; 
            position: relative; 
            display: flex; 
            justify-content: center; 
            background: rgba(255,255,255,0.9);
            border-radius: 8px;
            padding: 5px 0;
            overflow: hidden; 
        }
        
        canvas#staff-canvas { 
            width: 100%; 
            height: 200px; /* Hauteur fixe CSS, canvas interne g√©r√© par JS */
            z-index: 1; 
        }

        #detected-note {
            /* Modif Gillou d'origine: position: absolute; */
            position: absolute;  /* Modif Gillou d'origine: position: absolute;*/
            /* top: 4px; */
            /* right: 4px; */
            /* z-index: 10; */
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 0.8rem;
            text-align: center;
            pointer-events: none;
            border: 2px solid transparent; /* Modif Gillou Bordure invisible */
        }

        /* Clarinette Visuelle */
        #fingering-container { 
            width: 100%; 
            max-width: 180px; /* Plus √©troit pour mobile */
            height: auto;
            position: relative; 
            display: flex;
            justify-content: center; 
        }
        .clarinet-svg { 
            width: 100%; 
            height: auto; 
            max-height: 300px; /* Limite hauteur */
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5)); 
        }
        
        /* Modif Gillou Pour la Clarinette */
        .key { fill: #cfd8dc; stroke: #455a64; stroke-width: 1; transition: fill 0.2s; }
        /*.key { fill: #cfd8dc; stroke: #ef1b1b; stroke-width: 1; transition: fill 0.2s; } */
        .key.active { fill: var(--primary-btn); stroke: #fff; filter: drop-shadow(0 0 6px var(--primary-btn)); }
        
        /* Modif Gillou Pour la Clarinette */
        .hole { fill: #263238; stroke: #90a4ae; stroke-width: 2; } 
        /* .hole { fill: #f31515; stroke: #90a4ae; stroke-width: 2; }*/
        .hole.closed { fill: var(--primary-btn); stroke: #fff; }

        /* Feedback Area */
        #feedback-area {
            margin: 4px 0 8px 0;
            text-align: center;
            width: 100%;
            max-width: 600px;
        }

        .status-detected { 
            color: #333; 
            font-weight: 600;
            background: rgba(255,255,255,0.8);
            border: 1px solid #ccc;
        }
        
        .status-match { 
            color: #fff; 
            background-color: var(--start-btn); 
            padding: 2px 10px;
            border-radius: 12px;
            font-weight: 700; 
            font-size: 0.9rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: inline-block;
        }
        
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        /* Tuner Bar */
        #tuner-bar {
            width: 100%;
            height: 12px; /* Tr√®s fin : 8px*/
            background: rgba(0,0,0,0.4);
            margin-top: 2px;
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.1);
        }
        #tuner-indicator {
            width: 8px;
            height: 100%;
            background: #fff;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            transition: left 0.1s linear, background-color 0.2s;
            border-radius: 50%;
            box-shadow: 0 0 5px #fff;
        }
        #center-marker {
            width: 2px;
            height: 100%;
            background: var(--start-btn);
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1;
            opacity: 0.8;
        }
        
        #note-name-display {
            margin-top: 2px; 
            font-size: 1.2rem; 
            font-weight: 700; 
            /* Modif Gillou Couleur du nom de la note en dessous en rouge TROP FLASH !!! */
            color: var(--note-success);
            /* color: var(--primary-btn); */
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
            min-height: 1.5em;
        }

        /* Media Queries SP√âCIFIQUE MOBILE */
        @media (max-width: 600px) {
            h1 { font-size: 1.2rem; }
            #instruction { font-size: 0.75rem !important; }

            /* Grille compacte */
            #controls { 
                display: grid;
                grid-template-columns: 1fr 1fr 1fr; /* 3 colonnes pour gagner de la place */
                gap: 4px;
                padding: 4px;
            }
            
            select { grid-column: span 1; font-size: 0.75rem; padding: 2px 4px; height: 30px; }
            #mode-select { grid-column: 1 / span 2; } /* Prend 2 places */
            #level-select { grid-column: 3 / span 1; } 
            
            .slider-container { 
                grid-column: 1 / span 2; 
                height: 30px; 
            }
            
            #start-btn, #next-btn { 
                grid-column: 3 / span 1; 
                width: 100%; 
                font-size: 0.75rem; 
                height: 30px;
            }

            #main-display { flex-direction: column; align-items: center; }
            .panel { width: 100%; margin: 0 0 6px 0; padding: 6px; }
            
            .clarinet-svg { max-height: 280px; }
            
            /* Canvas ajust√© */
            canvas#staff-canvas { height: 160px; } /* Moins haut sur mobile */
        }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <h1>Clarinette üéµ</h1>
        <div id="instruction" style="font-size: 0.85rem; opacity: 0.9; font-weight: 300; margin-top:2px;">Micro requis ‚Ä¢ Jouez la note <b style="color:var(--danger-color)">Rouge</b></div>
    </header>

    <div id="controls">
        <select id="mode-select">
            <option value="single">Mode: 1 Note</option>
            <option value="series">Mode: S√©rie 5 Notes</option>
        </select>
        <select id="level-select">
            <option value="1">Niv 1: Chalumeau</option>
            <option value="2">Niv 2: Passage</option>
            <option value="3">Niv 3: Clairon</option>
            <option value="4">Niv 4: Chromatique</option>
            <option value="5">Niv 5: Expert</option>
        </select>

        <div class="slider-container">
            <label for="noise-gate" class="slider-label">Bruit de fond</label>
            <input type="range" id="noise-gate" min="0.01" max="0.2" step="0.01" value="0.05">
        </div>

        <button id="start-btn">üéôÔ∏è Micro</button>
        <button id="next-btn">‚è©</button>
    </div>

    <div id="feedback-area">
        <div id="tuner-bar"><div id="center-marker"></div><div id="tuner-indicator"></div></div>
    </div>

    <div id="main-display">
        <div class="panel glass-panel">
            <h3>Partition</h3>
            <div id="staff-container">
                <div id="detected-note" class="status-detected">---</div>
                <canvas id="staff-canvas"></canvas>
            </div>
            <div id="note-name-display"></div>
        </div>

        <div class="panel glass-panel">
            <h3>Doigt√© (Boehm)</h3>
            <div id="fingering-container">
                <svg class="clarinet-svg" viewBox="0 0 100 400" xmlns="http://www.w3.org/2000/svg">
                    <rect x="40" y="10" width="20" height="380" rx="10" fill="#181818" stroke="#333"/>
                    
                    <circle id="key-R" class="key" cx="25" cy="40" r="6" />
                    <text x="5" y="45" fill="#888" font-size="8">12(R)</text>

                    <circle id="key-T" class="hole" cx="50" cy="55" r="5" />
                    <text x="75" y="60" fill="#888" font-size="8">T</text>

                    <rect id="key-A" class="key" x="35" y="20" width="10" height="5" /> 
                    <rect id="key-Ab" class="key" x="35" y="28" width="10" height="5" /> 
                    
                    <circle id="key-L1" class="hole" cx="50" cy="80" r="5" />
                    <circle id="key-L2" class="hole" cx="50" cy="100" r="5" />
                    <circle id="key-L3" class="hole" cx="50" cy="120" r="5" />
                    
                    <rect id="key-L4-E" class="key" x="65" y="130" width="15" height="8" rx="2"/> 
                    <rect id="key-L4-F" class="key" x="65" y="140" width="15" height="8" rx="2"/> 
                    <rect id="key-L4-Fsharp" class="key" x="20" y="135" width="15" height="8" rx="2"/> 
                    
                    <rect id="key-Side1" class="key" x="65" y="90" width="8" height="20" rx="2"/> 

                    <circle id="key-R1" class="hole" cx="50" cy="180" r="5" />
                    <circle id="key-R2" class="hole" cx="50" cy="200" r="5" />
                    <circle id="key-R3" class="hole" cx="50" cy="220" r="5" />

                    <rect id="key-R4-E" class="key" x="20" y="230" width="15" height="8" rx="2"/>
                    <rect id="key-R4-F" class="key" x="20" y="240" width="15" height="8" rx="2"/>
                    <rect id="key-R4-Fsharp" class="key" x="65" y="235" width="15" height="8" rx="2"/>
                    <rect id="key-R4-Gsharp" class="key" x="65" y="215" width="15" height="8" rx="2"/> 
                </svg>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * --- TRADUCTION ET DONN√âES ---
 */
const FR_NOTES = {
    "C": "Do", "C#": "Do#", "Db": "R√©‚ô≠",
    "D": "R√©", "D#": "R√©#", "Eb": "Mi‚ô≠",
    "E": "Mi", 
    "F": "Fa", "F#": "Fa#", "Gb": "Sol‚ô≠",
    "G": "Sol", "G#": "Sol#", "Ab": "La‚ô≠",
    "A": "La", "A#": "La#", "Bb": "Si‚ô≠",
    "B": "Si"
};

function getFrenchNoteName(noteKey) {
    const match = noteKey.match(/^([A-G][#b]?)(\d)$/);
    if (match) {
        const name = FR_NOTES[match[1]] || match[1];
        return `${name} ${match[2]}`;
    }
    return noteKey;
}

const NOTES_DATA = {
    "E3": { freq: 146.83, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-E"] },
    "F3": { freq: 155.56, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-F"] },
    "F#3": { freq: 164.81, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Fsharp"] },
    "G3": { freq: 174.61, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3"] },
    "G#3": { freq: 185.00, keys: ["T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Gsharp"] },
    "A3": { freq: 196.00, keys: ["T", "L1", "L2", "L3", "R1", "R2"] },
    "A#3": { freq: 207.65, keys: ["T", "L1", "L2", "L3", "R1"] }, 
    "B3": { freq: 220.00, keys: ["T", "L1", "L2", "L3", "R2"] }, 
    "C4": { freq: 233.08, keys: ["T", "L1", "L2", "L3"] },
    "C#4": { freq: 246.94, keys: ["T", "L1", "L2", "L3", "L4-Fsharp"] },
    "D4": { freq: 261.63, keys: ["T", "L1", "L2"] },
    "D#4": { freq: 277.18, keys: ["T", "L1", "L2", "Side1"] },
    "E4": { freq: 293.66, keys: ["T", "L1"] },
    "F4": { freq: 311.13, keys: ["T"] },
    "F#4": { freq: 329.63, keys: ["L1"] },
    "G4": { freq: 349.23, keys: [] }, 
    "G#4": { freq: 369.99, keys: ["Ab"] },
    "A4": { freq: 392.00, keys: ["A"] },
    "A#4": { freq: 415.30, keys: ["A", "R"] }, 
    "B4": { freq: 440.00, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-E"] },
    "C5": { freq: 466.16, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "L4-F"] },
    "C#5": { freq: 493.88, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Fsharp"] },
    "D5": { freq: 523.25, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3"] },
    "D#5": { freq: 554.37, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2", "R3", "R4-Gsharp"] },
    "E5": { freq: 587.33, keys: ["R", "T", "L1", "L2", "L3", "R1", "R2"] },
    "F5": { freq: 622.25, keys: ["R", "T", "L1", "L2", "L3", "R1"] },
    "F#5": { freq: 659.25, keys: ["R", "T", "L1", "L2", "L3", "R2"] },
    "G5": { freq: 698.46, keys: ["R", "T", "L1", "L2", "L3"] },
    "G#5": { freq: 739.99, keys: ["R", "T", "L1", "L2", "L3", "R4-Gsharp"] },
    "A5": { freq: 783.99, keys: ["R", "T", "L1", "L2"] },
    "A#5": { freq: 830.61, keys: ["R", "T", "L1", "L2", "Side1"] },
    "B5": { freq: 880.00, keys: ["R", "T", "L1"] },
    "C6": { freq: 932.33, keys: ["R", "T"] }
};

// AJOUT DES B√âMOLS (Enharmonie)
const ENHARMONICS = {
    "Gb3": "F#3", "Ab3": "G#3", "Bb3": "A#3", "Db4": "C#4", "Eb4": "D#4",
    "Gb4": "F#4", "Ab4": "G#4", "Bb4": "A#4", "Db5": "C#5", "Eb5": "D#5",
    "Gb5": "F#5", "Ab5": "G#5", "Bb5": "A#5"
};

for (let [flat, sharp] of Object.entries(ENHARMONICS)) {
    if (NOTES_DATA[sharp]) {
        NOTES_DATA[flat] = NOTES_DATA[sharp];
    }
}

// Mise √† jour des Niveaux
const LEVELS = {
    1: ["E3", "F3", "F#3", "G3", "G#3", "A3", "Bb3", "B3", "C4", "C#4", "D4", "Eb4", "E4", "F4", "F#4", "G4"], 
    2: ["G3", "A3", "Bb3", "B3", "C4", "C#4", "D4", "Eb4", "E4", "F4", "F#4", "G4", "Ab4", "A4", "Bb4", "B4", "C5"], 
    3: ["C4", "C#4", "D4", "Eb4", "E4", "F4", "F#4", "G4", "Ab4", "A4", "Bb4", "B4", "C5", "C#5", "D5", "Eb5", "E5", "F5", "F#5", "G5"], 
    4: ["C#4", "Db4", "D#4", "Eb4", "F#4", "Gb4", "G#4", "Ab4", "A#4", "Bb4", "C#5", "Db5", "D#5", "Eb5", "F#5", "Gb5", "G#5", "Ab5"], 
    5: Object.keys(NOTES_DATA) 
};

/**
 * --- ETAT DU JEU ---
 */
let noteQueue = []; 
let queueIndex = 0; 

/**
 * --- MOTEUR AUDIO (AVEC NOISE GATE) ---
 */
let audioContext;
let analyser;
let microphone;
let isListening = false;

async function initAudio() {
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        if (audioContext.state === 'suspended') {
            await audioContext.resume();
        }
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 2048;
        
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        
        isListening = true;
        updatePitch();
        
        document.getElementById('start-btn').style.display = 'none';
        updateControlsVisibility();
        document.getElementById('instruction').innerText = "Jouez pour valider !";
        
        startNewSequence(); 
    } catch (err) {
        alert("Erreur Micro: " + err);
    }
}

function updateControlsVisibility() {
    const mode = document.getElementById('mode-select').value;
    // Grid g√®re l'affichage, on joue juste sur le display none/block
    const nextBtn = document.getElementById('next-btn');
    if (mode === 'single' && isListening) {
        nextBtn.style.display = 'inline-flex'; // inline-flex pour centrer le texte
    } else {
        nextBtn.style.display = 'none';
    }
}

function autoCorrelate(buf, sampleRate) {
    let size = buf.length;
    let rms = 0;
    for (let i = 0; i < size; i++) { let val = buf[i]; rms += val * val; }
    rms = Math.sqrt(rms / size);
    
    // Valeur slider
    const noiseThreshold = parseFloat(document.getElementById('noise-gate').value);
    
    if (rms < noiseThreshold) return -1; 

    let r1 = 0, r2 = size - 1, thres = 0.2;
    for (let i = 0; i < size / 2; i++) if (Math.abs(buf[i]) < thres) { r1 = i; break; }
    for (let i = 1; i < size / 2; i++) if (Math.abs(buf[size - i]) < thres) { r2 = size - i; break; }

    buf = buf.slice(r1, r2);
    size = buf.length;

    let c = new Array(size).fill(0);
    for (let i = 0; i < size; i++) for (let j = 0; j < size - i; j++) c[i] = c[i] + buf[j] * buf[j + i];

    let d = 0; while (c[d] > c[d + 1]) d++;
    let maxval = -1, maxpos = -1;
    for (let i = d; i < size; i++) { if (c[i] > maxval) { maxval = c[i]; maxpos = i; } }
    let T0 = maxpos;
    let x1 = c[T0 - 1], x2 = c[T0], x3 = c[T0 + 1];
    let a = (x1 + x3 - 2 * x2) / 2;
    let b = (x3 - x1) / 2;
    if (a) T0 = T0 - b / (2 * a);

    return sampleRate / T0;
}

function updatePitch() {
    if (!isListening) return;
    const buf = new Float32Array(analyser.fftSize);
    analyser.getFloatTimeDomainData(buf);
    const freq = autoCorrelate(buf, audioContext.sampleRate);
    if (freq !== -1) checkNote(freq);
    requestAnimationFrame(updatePitch);
}

/**
 * --- LOGIQUE DE JEU ---
 */

function getRandomNote(level) {
    const notesPool = LEVELS[level];
    return notesPool[Math.floor(Math.random() * notesPool.length)];
}

function startNewSequence() {
    const mode = document.getElementById('mode-select').value;
    const level = parseInt(document.getElementById('level-select').value);
    
    noteQueue = [];
    queueIndex = 0;
    
    const count = (mode === 'series') ? 5 : 1;
    
    for(let i=0; i<count; i++) {
        let newNote;
        do {
            newNote = getRandomNote(level);
        } while (noteQueue.length > 0 && newNote === noteQueue[noteQueue.length-1]);
        noteQueue.push(newNote);
    }
    
    updateUI();
}

function updateUI() {
    // R√©initialisation affichage
    const displayElement = document.getElementById('detected-note');
    displayElement.innerText = "Attente...";
    displayElement.className = "status-detected";
    // Modif Gillou pour "effacer les bords du Label contenant la fr√©quence per√ßue"
    // displayElement.style.backgroundColor = "rgba(255,255,255,0.8)"; // Reset background
    displayElement.style.backgroundColor = "rgba(255,255,255,0.1)"; // Reset background

    document.getElementById('tuner-indicator').style.left = "50%";
    document.getElementById('tuner-indicator').style.backgroundColor = "#fff";

    const currentNote = noteQueue[queueIndex];
    
    drawStaff(noteQueue, queueIndex);
    
    if(currentNote) {
        showFingering(currentNote);
        document.getElementById('note-name-display').innerText = getFrenchNoteName(currentNote);
    } else {
        document.getElementById('note-name-display').innerText = "S√©rie termin√©e !";
    }
}

function checkNote(detectedFreq) {
    if (queueIndex >= noteQueue.length) return;

    const currentTarget = noteQueue[queueIndex];
    const targetData = NOTES_DATA[currentTarget];
    const targetFreq = targetData.freq;
    
    const centsDiff = 600 * Math.log2(detectedFreq / targetFreq); 

    const tunerIndicator = document.getElementById('tuner-indicator');
    let displayCents = Math.max(-50, Math.min(50, centsDiff));
    tunerIndicator.style.left = `${50 + displayCents}%`;
    
    const displayElement = document.getElementById('detected-note');
    
    if (Math.abs(centsDiff) < 20) {
        tunerIndicator.style.backgroundColor = "var(--note-success)";
        
        if (!displayElement.dataset.successLocked) {
            displayElement.dataset.successLocked = "true";
            
            const mode = document.getElementById('mode-select').value;
            
            if (mode === 'series') {
                displayElement.innerHTML = `<span class="status-match">${getFrenchNoteName(currentTarget)} OK!</span>`;
                queueIndex++;
                
                setTimeout(() => {
                    displayElement.dataset.successLocked = "";
                    if (queueIndex >= noteQueue.length) {
                          displayElement.innerHTML = `<span class="status-match" style="background-color:var(--accent-gold); color:#1d3557;">TERMIN√â !</span>`;
                          drawStaff(noteQueue, queueIndex); 
                          setTimeout(startNewSequence, 1500);
                    } else {
                        updateUI();
                    }
                }, 200);
                
            } else {
                displayElement.innerHTML = `<span class="status-match">BRAVO !</span>`;
                setTimeout(() => {
                    displayElement.dataset.successLocked = "";
                    startNewSequence();
                }, 1500);
            }
        }
    } else {
        displayElement.innerText = `${Math.round(detectedFreq)} Hz`;
        displayElement.className = "status-detected"; // Reset class
        tunerIndicator.style.backgroundColor = Math.abs(centsDiff) > 50 ? "var(--danger-color)" : "#fff";
    }
}

/**
 * --- DESSIN CANVAS (AVEC B√âMOLS ET CENTRAGE DYNAMIQUE) ---
 */
const canvas = document.getElementById('staff-canvas');
const ctx = canvas.getContext('2d');

function drawStaff(notes, activeIndex) {
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    
    // Ajustement de la r√©solution
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    ctx.scale(dpr, dpr);
    
    const width = rect.width;
    const height = rect.height;

    ctx.clearRect(0, 0, width, height);
    
    const isSmallScreen = width < 400; // D√©tection petit √©cran
    const lineSpacing = isSmallScreen ? 11 : 14; // R√©duit l'espace sur mobile pour tout faire rentrer
    
    // Calcul pour centrer la port√©e verticalement
    // La port√©e fait 4 espaces de haut. Le centre de la port√©e est √† 2 * lineSpacing + staffY
    // On veut que ce centre soit √† height / 2.
    const staffY = (height / 2) - (2 * lineSpacing);
    
    const startX = 20;
    const endX = width - 20;
    
    // Lignes de port√©e
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 1;
    for (let i = 0; i < 5; i++) {
        let y = staffY + (i * lineSpacing);
        ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(endX, y); ctx.stroke();
    }
    
    // Cl√© de sol
    ctx.font = isSmallScreen ? "40px serif" : "50px serif";
    ctx.fillStyle = "#333";
    // Ajustement position cl√© selon taille
    const clefOffset = isSmallScreen ? 34 : 42;
    ctx.fillText("ùÑû", 10, staffY + clefOffset);

    let xOffset = (notes.length === 1) ? (width / 2) : 60;

    const noteStepsFromTop = {
        "C6": -2, "B5": -1.5, "Bb5": -1.5, "A#5": -1, "A5": -1, "Ab5": -1, "G#5": -0.5, "G5": -0.5, "Gb5": -0.5,
        "F#5": 0, "F5": 0, "E5": 0.5, "Eb5": 0.5, "D#5": 1, "D5": 1, "Db5": 1, "C#5": 1.5, "C5": 1.5,
        "B4": 2, "Bb4": 2, "A#4": 2.5, "A4": 2.5, "Ab4": 2.5, "G#4": 3, "G4": 3, "Gb4": 3, "F#4": 3.5, "F4": 3.5,
        "E4": 4, "Eb4": 4, "D#4": 4.5, "D4": 4.5, "Db4": 4.5, "C#4": 5, "C4": 5, "B3": 5.5, "Bb3": 5.5,
        "A#3": 6, "A3": 6, "Ab3": 6, "G#3": 6.5, "G3": 6.5, "Gb3": 6.5, "F#3": 7, "F3": 7, "E3": 7.5
    };

    notes.forEach((noteName, idx) => {
        const steps = noteStepsFromTop[noteName];
        const noteY = staffY + (steps * lineSpacing);
        
        let noteX = xOffset;
        if (notes.length > 1) {
            noteX = 70 + (idx * ((width - 100) / (notes.length - 1)));
        }

        ctx.strokeStyle = "#333"; 
        // Lignes suppl√©mentaires (Ledger lines)
        // Bas
        if (steps >= 5) { 
            for (let s = 5; s <= steps; s++) {
                if (s % 1 === 0) {
                    let ly = staffY + (s * lineSpacing);
                    ctx.beginPath(); ctx.moveTo(noteX - 12, ly); ctx.lineTo(noteX + 12, ly); ctx.stroke();
                }
            }
        }
        // Haut
        if (steps <= -1) { 
            for (let s = -1; s >= steps; s--) {
                if (s % 1 === 0) {
                    let ly = staffY + (s * lineSpacing);
                    ctx.beginPath(); ctx.moveTo(noteX - 12, ly); ctx.lineTo(noteX + 12, ly); ctx.stroke();
                }
            }
        }

        let noteColor = "var(--note-pending)";
        if (idx < activeIndex) noteColor = "var(--note-success)";
        else if (idx === activeIndex) noteColor = "var(--note-current)";

        ctx.beginPath();
        // Taille note l√©g√®rement r√©duite si petit √©cran
        const noteRadiusX = isSmallScreen ? 8 : 9;
        const noteRadiusY = isSmallScreen ? 6 : 7;
        ctx.ellipse(noteX, noteY, noteRadiusX, noteRadiusY, 0, 0, 2 * Math.PI);
        
        if(noteColor.includes("success")) ctx.fillStyle = "#06d6a0";
        else if(noteColor.includes("current")) ctx.fillStyle = "#ef476f";
        else ctx.fillStyle = "#000";
        
        ctx.fill();

        ctx.font = isSmallScreen ? "18px Arial" : "22px Arial";
        if (noteName.includes("#")) {
            ctx.fillText("‚ôØ", noteX - 22, noteY + 6);
        } else if (noteName.includes("b")) {
            ctx.fillText("‚ô≠", noteX - 22, noteY + 4);
        }
    });
}

function showFingering(noteName) {
    document.querySelectorAll('.key, .hole').forEach(el => {
        el.style.fill = ""; 
        el.style.stroke = ""; 
        el.classList.remove('active', 'closed'); 
    });

    const data = NOTES_DATA[noteName];
    if (!data) return;

    data.keys.forEach(keyId => {
        const el = document.getElementById(`key-${keyId}`);
        if (el) {
            if (el.classList.contains('hole')) {
                el.classList.add('closed'); 
            } else {
                el.classList.add('active'); 
            }
        }
    });
}

// Events
document.getElementById('start-btn').addEventListener('click', initAudio);
document.getElementById('next-btn').addEventListener('click', startNewSequence); 
document.getElementById('level-select').addEventListener('change', () => { if(isListening) startNewSequence(); });
document.getElementById('mode-select').addEventListener('change', () => { 
    updateControlsVisibility();
    if(isListening) startNewSequence(); 
});

window.addEventListener('resize', () => {
    if(noteQueue.length > 0) drawStaff(noteQueue, queueIndex);
});

</script>
</body>
</html>